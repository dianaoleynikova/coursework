generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int            @id @default(autoincrement())
  username      String         @unique @db.VarChar(50)
  email         String         @unique @db.VarChar(255)
  passwordHash  String         @map("password_hash") @db.VarChar(255)
  fullName      String?        @map("full_name") @db.VarChar(100)
  bio           String?
  avatarUrl     String?        @map("avatar_url") @db.VarChar(500)
  isActive      Boolean        @default(true) @map("is_active")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  deletedAt     DateTime?      @map("deleted_at")
  commentLikes  CommentLike[]
  comments      Comment[]
  followers     Follower[]     @relation("UserFollowers")
  following     Follower[]     @relation("UserFollowing")
  notifications Notification[]
  postLikes     PostLike[]
  posts         Post[]

  @@index([username])
  @@index([email])
  @@map("users")
}

model Category {
  id          Int      @id @default(autoincrement())
  name        String   @unique @db.VarChar(100)
  slug        String   @unique @db.VarChar(100)
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  posts       Post[]

  @@index([slug])
  @@map("categories")
}

model Tag {
  id         Int       @id @default(autoincrement())
  name       String    @unique @db.VarChar(50)
  slug       String    @unique @db.VarChar(50)
  usageCount Int       @default(0) @map("usage_count")
  createdAt  DateTime  @default(now()) @map("created_at")
  postTags   PostTag[]

  @@index([slug])
  @@index([usageCount(sort: Desc)])
  @@map("tags")
}

model Post {
  id            Int        @id @default(autoincrement())
  authorId      Int        @map("author_id")
  categoryId    Int?       @map("category_id")
  title         String     @db.VarChar(255)
  slug          String     @unique @db.VarChar(255)
  content       String
  excerpt       String?
  coverImageUrl String?    @map("cover_image_url") @db.VarChar(500)
  status        PostStatus @default(draft)
  viewCount     Int        @default(0) @map("view_count")
  publishedAt   DateTime?  @map("published_at")
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")
  deletedAt     DateTime?  @map("deleted_at")
  comments      Comment[]
  postLikes     PostLike[]
  postTags      PostTag[]
  author        User       @relation(fields: [authorId], references: [id], onDelete: Cascade)
  category      Category?  @relation(fields: [categoryId], references: [id])

  @@index([authorId])
  @@index([categoryId])
  @@index([status])
  @@index([publishedAt(sort: Desc)])
  @@index([slug])
  @@map("posts")
}

model PostTag {
  postId    Int      @map("post_id")
  tagId     Int      @map("tag_id")
  createdAt DateTime @default(now()) @map("created_at")
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([postId, tagId])
  @@index([tagId])
  @@map("post_tags")
}

model Comment {
  id              Int           @id @default(autoincrement())
  postId          Int           @map("post_id")
  authorId        Int           @map("author_id")
  parentCommentId Int?          @map("parent_comment_id")
  content         String
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  deletedAt       DateTime?     @map("deleted_at")
  commentLikes    CommentLike[]
  author          User          @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parentComment   Comment?      @relation("CommentReplies", fields: [parentCommentId], references: [id], onDelete: Cascade)
  replies         Comment[]     @relation("CommentReplies")
  post            Post          @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([authorId])
  @@index([parentCommentId])
  @@index([createdAt(sort: Desc)])
  @@map("comments")
}

model PostLike {
  userId    Int      @map("user_id")
  postId    Int      @map("post_id")
  createdAt DateTime @default(now()) @map("created_at")
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, postId])
  @@index([postId])
  @@index([userId])
  @@map("post_likes")
}

model CommentLike {
  userId    Int      @map("user_id")
  commentId Int      @map("comment_id")
  createdAt DateTime @default(now()) @map("created_at")
  comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, commentId])
  @@index([commentId])
  @@map("comment_likes")
}

model Follower {
  followerId  Int      @map("follower_id")
  followingId Int      @map("following_id")
  createdAt   DateTime @default(now()) @map("created_at")
  follower    User     @relation("UserFollowers", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("UserFollowing", fields: [followingId], references: [id], onDelete: Cascade)

  @@id([followerId, followingId])
  @@index([followingId])
  @@index([followerId])
  @@map("followers")
}

model Notification {
  id               Int              @id @default(autoincrement())
  userId           Int              @map("user_id")
  type             NotificationType
  relatedUserId    Int?             @map("related_user_id")
  relatedPostId    Int?             @map("related_post_id")
  relatedCommentId Int?             @map("related_comment_id")
  message          String
  isRead           Boolean          @default(false) @map("is_read")
  createdAt        DateTime         @default(now()) @map("created_at")
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([createdAt(sort: Desc)])
  @@map("notifications")
}

enum PostStatus {
  draft
  published
  archived
}

enum NotificationType {
  new_follower
  post_like
  comment
  comment_like
  mention
}
